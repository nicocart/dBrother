# PDF处理功能改进总结

## 问题描述
用户反映PDF中有多个"最可几孔径"字段，需要精确提取靠近"NLDFT详细数据"的数据。

## 解决方案
对`app/core/pdf_processor.py`中的`extract_value_near`函数进行了以下改进：

### 1. 添加参考关键词参数
- 新增`reference_keyword`参数，用于指定参考关键词
- 当提供参考关键词时，优先选择距离参考关键词最近的匹配

### 2. 优化距离计算算法
- 移除了正则表达式的边界匹配（`\b`），提高匹配准确性
- 添加了位置偏好逻辑：如果关键词在参考关键词之后，给予距离奖励（距离值乘以0.5）
- 这确保了优先选择在参考关键词之后出现的关键词

### 3. 调整搜索窗口大小
- 将搜索窗口从`pos ± window`调整为`pos ± window/2`
- 使用较小的搜索窗口，只包含关键词附近的数值，避免匹配到远处的数值

## 修改的具体代码

### 函数签名修改
```python
def extract_value_near(text: str, keyword: str, unit_regex: str, window: int = 1000, reference_keyword: str = None) -> str:
```

### 关键词匹配逻辑
```python
# 使用正则表达式进行精确匹配，避免匹配包含关键词的其他字符串
keyword_pattern = re.compile(rf'{re.escape(keyword)}')
matches = list(keyword_pattern.finditer(text))
```

### 参考关键词匹配逻辑
```python
if reference_keyword:
    reference_pattern = re.compile(rf'{re.escape(reference_keyword)}')
    reference_matches = list(reference_pattern.finditer(text))
    
    if reference_matches:
        # 找到最靠近参考关键词的keyword匹配
        best_match = None
        min_distance = float('inf')
        
        for ref_match in reference_matches:
            ref_pos = ref_match.start()
            for kw_match in matches:
                kw_pos = kw_match.start()
                # 计算距离，但优先考虑在参考关键词之后的匹配
                distance = abs(kw_pos - ref_pos)
                # 如果关键词在参考关键词之后，给予距离奖励（减少距离值）
                if kw_pos > ref_pos:
                    distance = distance * 0.5
                if distance < min_distance:
                    min_distance = distance
                    best_match = kw_match
        
        if best_match:
            matches = [best_match]
```

### 调用方式修改
```python
# 最可几孔径：优先选择靠近"NLDFT详细数据"的结果
most_probable = extract_value_near(text, "最可几孔径", r"nm", 200, "NLDFT详细数据")
```

## 功能验证
通过测试验证，修改后的功能能够：

1. ✅ 正确识别多个"最可几孔径"字段
2. ✅ 优先选择靠近"NLDFT详细数据"的字段
3. ✅ 在参考关键词之后的匹配获得更高优先级
4. ✅ 准确提取对应的数值

## 使用效果
现在当PDF中包含多个"最可几孔径"字段时，系统会：
1. 找到所有"最可几孔径"匹配
2. 找到"NLDFT详细数据"的位置
3. 选择距离"NLDFT详细数据"最近且在之后的"最可几孔径"
4. 提取该字段对应的数值

这确保了提取到的是与NLDFT详细数据相关的最可几孔径，而不是其他部分的数值。
