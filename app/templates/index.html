<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>dBrother - BJH报告分析工具</title>
    <meta name="description" content="专业的PDF孔径分析工具，自动提取和分析孔径分布数据">
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🔬</text></svg>">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{{ url_for('static', path='/css/style.css') }}">
    <!-- Cookieless and GDPR compliant analytics by Rybbit -->
    <script
    src="https://rybbit.linlinfacai.cc/api/script.js"
    data-site-id="7d7b8255d854"
    defer
    ></script>
</head>
<body>
    <div class="container">
        <header class="text-center my-4">
            <h1 class="display-4">dBrother - BJH报告分析工具</h1>
            <p class="text-muted">
                <small>
                    作者: Leon | 
                    <a href="https://github.com/nicocart" target="_blank" class="text-decoration-none">@nicocart</a>
                </small>
            </p>
        </header>

        <div class="row justify-content-center">
            <div class="col-md-10">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <div class="upload-area" id="uploadArea">
                            <div class="upload-icon">
                                <i class="bi bi-file-earmark-pdf fs-1"></i>
                            </div>
                            <h3>拖放 PDF 到此处</h3>
                            <p>或</p>
                            <label for="fileInput" class="btn btn-primary">选择文件</label>
                            <input type="file" id="fileInput" accept=".pdf" style="display: none;">
                            <p class="text-muted mt-2">最大文件大小：2 MB</p>
                        </div>

                        <div class="progress mt-3 d-none" id="uploadProgress">
                            <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>

                        <div class="alert alert-danger mt-3 d-none" id="errorAlert">
                            <i class="bi bi-exclamation-triangle-fill"></i>
                            <span id="errorMessage"></span>
                        </div>
                    </div>
                </div>

                <!-- 结果卡片 -->
                <div class="card shadow-sm mt-4 d-none" id="resultCard">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="bi bi-check-circle-fill"></i> 分析完成</h5>
                    </div>
                    <div class="analysis-meta d-none" id="analysisMeta">
                        <i class="bi bi-file-earmark-pdf me-2"></i>
                        <span class="meta-label">当前文件：</span>
                        <span id="currentFileName">-</span>
                    </div>
                    <div class="card-body">
                        <ul class="nav nav-tabs" id="resultTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="summary-tab" data-bs-toggle="tab" data-bs-target="#summary" type="button" role="tab">基本数据</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="advanced-tab" data-bs-toggle="tab" data-bs-target="#advanced" type="button" role="tab">高级分析</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="chart-tab" data-bs-toggle="tab" data-bs-target="#chart" type="button" role="tab">图表</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="data-tab" data-bs-toggle="tab" data-bs-target="#data" type="button" role="tab">原始数据</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="raw-text-tab" data-bs-toggle="tab" data-bs-target="#raw-text" type="button" role="tab">原始文本</button>
                            </li>
                        </ul>
                        <div class="tab-content p-3" id="resultTabsContent">
                            <!-- 基本数据标签页 -->
                            <div class="tab-pane fade show active" id="summary" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="data-item">
                                            <div class="data-label">单点BET比表面积</div>
                                            <div class="data-value" id="spBet">-</div>
                                            <div class="data-unit">m²/g</div>
                                        </div>
                                        <div class="data-item">
                                            <div class="data-label">多点BET比表面积</div>
                                            <div class="data-value" id="mpBet">-</div>
                                            <div class="data-unit">m²/g</div>
                                        </div>
                                        <div class="data-item">
                                            <div class="data-label">最高单点吸附总孔体积</div>
                                            <div class="data-value" id="totalPoreVol">-</div>
                                            <div class="data-unit">cm³/g</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="data-item">
                                            <div class="data-label">单点总孔吸附平均孔直径</div>
                                            <div class="data-value" id="avgPoreD">-</div>
                                            <div class="data-unit">nm</div>
                                        </div>
                                        <div class="data-item">
                                            <div class="data-label">最可几孔径</div>
                                            <div class="data-value" id="mostProbable">-</div>
                                            <div class="data-unit">nm</div>
                                        </div>
                                        <div class="data-item">
                                            <div class="data-label">D90/D10比值</div>
                                            <div class="data-value" id="d90d10Ratio">-</div>
                                            <div class="data-unit"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 高级分析标签页 -->
                            <div class="tab-pane fade" id="advanced" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="data-item">
                                            <div class="data-label">D10</div>
                                            <div class="data-value" id="d10">-</div>
                                            <div class="data-unit">nm</div>
                                        </div>
                                        <div class="data-item">
                                            <div class="data-label">D90</div>
                                            <div class="data-value" id="d90">-</div>
                                            <div class="data-unit">nm</div>
                                        </div>
                                        <div class="data-item">
                                            <div class="data-label">孔容A（最大孔积分体积）</div>
                                            <div class="data-value" id="poreVolumeA">-</div>
                                            <div class="data-unit">cm³/g</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="data-item">
                                            <div class="data-label">0.5D（最可几孔径×0.5）</div>
                                            <div class="data-value" id="d05">-</div>
                                            <div class="data-unit">nm</div>
                                        </div>
                                        <div class="data-item">
                                            <div class="data-label">＜0.5D的百分比</div>
                                            <div class="data-value" id="lessThan05D">-</div>
                                            <div class="data-unit">%</div>
                                        </div>
                                        <div class="data-item">
                                            <div class="data-label">＞1.5D的百分比</div>
                                            <div class="data-value" id="greaterThan15D">-</div>
                                            <div class="data-unit">%</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 图表标签页 -->
                            <div class="tab-pane fade" id="chart" role="tabpanel">
                                <div class="chart-container">
                                    <canvas id="nldftChart"></canvas>
                                </div>
                            </div>
                            
                            <!-- 原始数据标签页 -->
                            <div class="tab-pane fade" id="data" role="tabpanel">
                                <div class="table-responsive">
                                    <table class="table table-striped table-sm">
                                        <thead>
                                            <tr>
                                                <th>序号</th>
                                                <th>平均孔直径 (nm)</th>
                                                <th>孔积分体积 (cm³/g)</th>
                                            </tr>
                                        </thead>
                                        <tbody id="nldftTableBody">
                                            <!-- 数据将通过JS动态填充 -->
                                        </tbody>
                                    </table>
                                </div>
                                <div class="text-center mt-3">
                                    <button class="btn btn-outline-primary" id="downloadCsvBtn">
                                        <i class="bi bi-download"></i> 下载CSV
                                    </button>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="raw-text" role="tabpanel" aria-labelledby="raw-text-tab">
                                <div class="d-flex justify-content-end gap-2 mb-3">
                                    <button class="btn btn-outline-secondary btn-sm" id="copyRawBtn">
                                        <i class="bi bi-clipboard-check"></i> 复制文本
                                    </button>
                                    <button class="btn btn-primary btn-sm" id="downloadRawBtn">
                                        <i class="bi bi-download"></i> 下载TXT
                                    </button>
                                </div>
                                <div class="raw-text-container">
                                    <pre class="raw-text-content" id="rawTextContent">上传PDF后将在此显示原始文本</pre>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer class="text-center mt-5 mb-3">
            <p class="text-muted">© 2025 dBrother</p>
        </footer>

        <!-- 关于按钮 -->
        <button class="about-btn" data-bs-toggle="modal" data-bs-target="#aboutModal" title="关于项目">
            <i class="bi bi-info-circle"></i>
        </button>

        <!-- 关于模态框 -->
        <div class="modal fade" id="aboutModal" tabindex="-1" aria-labelledby="aboutModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="aboutModalLabel">
                            <i class="bi bi-info-circle"></i> 关于 dBrother
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body about-content">
                        <div class="thanks-section">
                            <h5>致谢</h5>
                            <p><strong>特别感谢：</strong>Ling Feng 提供思路</p>
                            <p>感谢所有为这个项目提供帮助和支持的朋友们！</p>
                        </div>

                        <h5>项目简介</h5>
                        <p>dBrother 是一个专业的 PDF 孔径分析工具，围绕实验报告实现全结构化抽取与可视化展示。最新版利用 pdfplumber 的表格定位能力直接读取原始数据，辅以多段插值与异常检测，确保分析结果更稳定、可追溯。</p>
                        
                        <div class="author-info">
                            <h5>作者信息</h5>
                            <p><strong>作者：</strong>Leon</p>
                            <p><strong>GitHub：</strong><a href="https://github.com/nicocart" target="_blank">@nicocart</a></p>
                            <p><strong>项目地址：</strong><a href="https://github.com/nicocart/dBrother" target="_blank">https://github.com/nicocart/dBrother</a></p>
                        </div>

                        <h5>开源依赖</h5>
                        <p>本项目基于以下优秀的开源项目构建：</p>
                        <ul>
                            <li><strong>FastAPI</strong> - 现代、快速的Web框架</li>
                            <li><strong>pdfplumber</strong> - PDF 表格/文本解析库</li>
                            <li><strong>Bootstrap</strong> - 响应式UI框架</li>
                            <li><strong>Chart.js</strong> - 数据可视化图表库</li>
                            <li><strong>jQuery</strong> - JavaScript工具库</li>
                        </ul>

                        <h5>技术特性</h5>
                        <ul>
                            <li>基于 pdfplumber 的表格/字段结构化解析</li>
                            <li>多指标自动计算（D10/D90、孔容分段等）</li>
                            <li>交互式图表与原始数据导出</li>
                            <li>响应式布局，支持移动端体验</li>
                            <li>解析过程校验与错误提示</li>
                            <li>隐私保护：文件处理后立即清理</li>
                        </ul>

                        <h5>版本信息</h5>
                        <p><strong>当前版本：</strong>1.1.0</p>
                        <p><strong>最后更新：</strong>2025年10月21日</p>

                        <h5>更新日志</h5>
                        <ul>
                            <li><strong>1.1.0</strong>（2025-10-21）引入 pdfplumber 表格解析、统一结构化通道，重塑全站 UI 与异常校验。</li>
                            <li><strong>1.0.0</strong>（2025-08-26）首个公开版本，提供正则提取与基础可视化。</li>
                        </ul>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                        <a href="https://github.com/nicocart/dBrother" target="_blank" class="btn btn-primary">
                            <i class="bi bi-github"></i> 查看源码
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 加载中遮罩 -->
    <div class="loading-overlay d-none" id="loadingOverlay">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">加载中...</span>
        </div>
        <div class="loading-text">正在解析 PDF，请稍候…</div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- 调试脚本 -->
    <script>
        // 检查库加载状态
        window.addEventListener('load', function() {
            console.log('页面加载完成');
            console.log('jQuery版本:', typeof $ !== 'undefined' ? $.fn.jquery : '未加载');
            console.log('Chart.js版本:', typeof Chart !== 'undefined' ? Chart.version : '未加载');
            console.log('Bootstrap版本:', typeof bootstrap !== 'undefined' ? '已加载' : '未加载');
            
            // 如果Chart.js未加载，尝试重新加载
            if (typeof Chart === 'undefined') {
                console.warn('Chart.js未加载，尝试重新加载...');
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js';
                script.onload = function() {
                    console.log('Chart.js重新加载成功');
                };
                script.onerror = function() {
                    console.error('Chart.js重新加载失败');
                };
                document.head.appendChild(script);
            }
        });
    </script>
    
    <script src="{{ url_for('static', path='/js/main.js') }}"></script>
</body>
</html>

